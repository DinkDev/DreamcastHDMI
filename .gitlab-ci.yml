stages:
  - build-firmware-utils
  - build-fpga
  - build-esp
  - prepare-folders
  # - deploy
  # - publish

variables:
  ARTIFACT_STORAGE_DIR: "/srv/builds/artifacts"

firmware-utils:
  image:
    name: chriz2600/firmware-utils-builder:latest
  stage: build-firmware-utils
  script:
    - "cd firmware-utils"
    - "make install"
  artifacts:
    name: "firmware-utils-${CI_COMMIT_REF_NAME}"
    paths:
      - firmware-utils/firmware-packer
      - firmware-utils/firmware-unpacker
  tags:
    - docker
  only:
    - develop
    - master
    - experimental
    - bleeding
    - tags

fpga-firmware:
  image:
      name: chriz2600/quartus-lite:18.1
  stage: build-fpga
  script: 
    - ./Core/source/ram/create_text_ram.pl
    - script -qfc "$(printf "%q " "./Core/build-all")" /dev/null
  artifacts:
    name: "fpga-firmware-${CI_COMMIT_REF_NAME}"
    paths:
      - Core/output_files/std/*.jic
      - Core/output_files/std/*.rbf
      - Core/output_files/std/*.dc
      - Core/output_files/hq2x/*.jic
      - Core/output_files/hq2x/*.rbf
      - Core/output_files/hq2x/*.dc
      - Core/output_files/*.dc
      - Core/output_files/*.jic
      - Core/output_files/*.rbf
  dependencies:
    - firmware-utils
  tags:
    - docker
  only:
    - develop
    - master
    - experimental
    - bleeding
    - tags

esp-firmware:
  image:
    name: chriz2600/platformio:4.0
  stage: build-esp
  script:
    - "./ESP/build-all"
  artifacts:
    name: "esp-firmware-${CI_COMMIT_REF_NAME}"
    paths:
      - ESP/.pio/build/std/firmware.bin
      - ESP/.pio/build/std/spiffs.bin
      - ESP/.pio/build/hq2x/firmware.bin
      - ESP/.pio/build/hq2x/spiffs.bin
      - ESP/.pio/build/firmware.bin
      - ESP/.pio/build/spiffs.bin
      - ESP/data/index.html.gz
      - ESP/data/changelog
  dependencies:
    - fpga-firmware
  tags:
    - docker
  only:
    - develop
    - master
    - experimental
    - bleeding
    - tags

prepare-fpga-branch-folder:
  image:
    name: chriz2600/publish-utils:latest
  stage: prepare-folders
  script:
    - "prepare-fpga-branch-folder std"
    - "prepare-fpga-branch-folder hq2x"
    - "prepare-fpga-branch-folder"
  artifacts:
    name: "fpga-${CI_COMMIT_REF_NAME}"
    paths:
      - "docroot"
  dependencies:
    - fpga-firmware
  tags:
    - docker
  only:
    - develop
    - master
    - experimental
    - bleeding
    - tags


# fpga-publish:
#   image:
#     name: chriz2600/publish-utils:latest
#   stage: deploy
#   script: 
#     - "create-index-html std"
#     - "create-index-html hq2x"
#     - "create-index-html"
#   artifacts:
#     expire_in: 1 sec
#   dependencies:
#     - fpga-firmware
#   tags:
#     - docker
#   only:
#     - develop
#     - master
#     - experimental
#     - bleeding
#     - tags

# esp-publish:
#   image:
#     name: chriz2600/publish-utils:latest
#   stage: deploy
#   script: 
#     - "create-index-html-esp std ESP"
#     - "create-index-html-esp hq2x ESP"
#     - "create-index-html-esp '' ESP"
#   artifacts:
#     expire_in: 1 sec
#   dependencies:
#     - esp-firmware
#   tags:
#     - docker
#   only:
#     - develop
#     - master
#     - experimental
#     - bleeding
#     - tags

# finish-publish:
#   image:
#     name: chriz2600/publish-utils:latest
#   stage: publish
#   script:
#     - "dc-atomic-move std"
#     - "dc-atomic-move hq2x"
#     - "dc-atomic-move"
#   artifacts:
#     expire_in: 1 sec
#   dependencies:
#     - fpga-publish
#     - esp-publish
#   tags:
#     - docker
#   only:
#     - develop
#     - master
#     - experimental
#     - bleeding
#     - tags
